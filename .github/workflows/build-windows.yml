name: 构建 Windows 可执行文件

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: 拉取代码（含完整历史）
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 安装 VS2022 构建工具（核心组件，不指定 SDK）
        run: |
          # 安装 Chocolatey（若未安装）
          if (-not (Get-Command choco -ErrorAction SilentlyContinue)) {
            Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          }
          # 安装 VS2022 构建工具（仅核心组件，依赖环境预装的 SDK）
          choco install visualstudio2022buildtools --yes --no-progress `
            --package-parameters "--add Microsoft.VisualStudio.Component.MSBuild `
                                --add Microsoft.VisualStudio.Component.VC.Tools.x86.x64 `
                                --add Microsoft.VisualStudio.Component.VC.143.BuildTools `
                                --installPath C:\VS2022BuildTools"

      - name: 自动检测环境中可用的 Windows SDK 版本
        id: find_sdk
        run: |
          # 查找系统中已安装的最高版本 Windows SDK
          $sdkPaths = Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\bin\" | Where-Object { $_.Name -match '^\d+\.\d+\.\d+\.\d+$' } | Sort-Object Name -Descending
          if ($sdkPaths.Count -eq 0) {
            Write-Error "未找到任何 Windows SDK！"
            exit 1
          }
          $latestSdkVersion = $sdkPaths[0].Name
          Write-Host "检测到最新 Windows SDK 版本：$latestSdkVersion"
          echo "WINDOWS_SDK_VERSION=$latestSdkVersion" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: 配置 MSBuild 路径
        run: |
          $msbuildPath = "C:\VS2022BuildTools\MSBuild\Current\Bin\MSBuild.exe"
          echo "MSBUILD_PATH=$msbuildPath" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          if (Test-Path $msbuildPath) {
            Write-Host "MSBuild 路径：$msbuildPath"
            & $msbuildPath -version
          } else {
            Write-Error "MSBuild 未找到！"
            exit 1
          }

      - name: 编译项目（自动适配 SDK + v143 工具集）
        run: |
          & $env:MSBUILD_PATH "SocialNetwork.sln" `
            /t:Build `
            /p:Configuration=Release `
            /p:Platform=x64 `
            /p:PlatformToolset=v143 `
            /p:WindowsTargetPlatformVersion=$env:WINDOWS_SDK_VERSION `
            /p:OutDir="./bin/Release/" `
            /verbosity:minimal `
            /p:UseEnv=true  # 强制使用环境变量中的 SDK 路径

      - name: 生成更新日志
        id: generate_changelog
        run: |
          $lastTag = git describe --abbrev=0 --tags HEAD^ 2>$null
          if (-not $lastTag) {
            $changelog = git log --pretty=format:"- %s" HEAD
          } else {
            $changelog = git log "$lastTag..HEAD" --pretty=format:"- %s"
          }
          if (-not $changelog) { $changelog = "无显著更新" }
          echo "CHANGELOG=$changelog" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: 创建 GitHub Release 并上传 EXE
        uses: softprops/action-gh-release@v2
        with:
          files: ./bin/Release/*.exe
          name: Release ${{ github.ref_name }}
          body: |
            ## 更新日志
            ${{ env.CHANGELOG }}
            
            自动构建版本：${{ github.ref_name }}
            使用 Windows SDK 版本：${{ env.WINDOWS_SDK_VERSION }}