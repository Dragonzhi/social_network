name: æ„å»º Windows å¯æ‰§è¡Œæ–‡ä»¶

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: æ‹‰å–ä»£ç 
      uses: actions/checkout@v4

    - name: é…ç½® MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: ğŸ”¥ å…¨å±€å¼ºåˆ¶UTF-8ç¼–ç ï¼ˆæ ¸å¿ƒï¼šè§£å†³ä»£ç é¡µ1252é—®é¢˜ï¼‰
      run: |
        # 1. åˆ‡æ¢æ§åˆ¶å°ä»£ç é¡µä¸ºUTF-8ï¼ˆ65001ï¼‰
        chcp 65001 > nul
        # 2. è®¾ç½®ç³»ç»Ÿé»˜è®¤ç¼–ç ä¸ºUTF-8ï¼ˆæ°¸ä¹…ç”Ÿæ•ˆï¼‰
        reg add "HKLM\SYSTEM\CurrentControlSet\Control\Nls\CodePage" /v CP_ACP /t REG_SZ /d 65001 /f
        reg add "HKLM\SYSTEM\CurrentControlSet\Control\Nls\CodePage" /v CP_OEMCP /t REG_SZ /d 65001 /f
        # 3. è®¾ç½®ç³»ç»ŸåŒºåŸŸä¸ºä¸­æ–‡
        reg add "HKCU\Control Panel\International" /v LocaleName /t REG_SZ /d zh-CN /f
        reg add "HKLM\SYSTEM\CurrentControlSet\Control\Nls\Language" /v Default /t REG_SZ /d 0804 /f
      shell: cmd

    - name: å®‰è£…ä¸­æ–‡è¯­è¨€åŒ…ï¼ˆä¿®æ­£DISMåŠŸèƒ½åï¼‰
      run: |
        # æ­£ç¡®çš„ç®€ä½“ä¸­æ–‡åŸºç¡€è¯­è¨€åŒ…åŠŸèƒ½å
        dism /online /enable-feature /featurename:Language.Basic~~~zh-CN~~~0.0.1.0 /all /quiet /norestart
        # å®‰è£…ä¸­æ–‡è¾“å…¥æ³•æ”¯æŒï¼ˆå¯é€‰ï¼Œå…œåº•ï¼‰
        dism /online /enable-feature /featurename:Language.Handwriting~~~zh-CN~~~0.0.1.0 /all /quiet /norestart
        dism /online /enable-feature /featurename:Language.OCR~~~zh-CN~~~0.0.1.0 /all /quiet /norestart
      shell: cmd
      continue-on-error: true  # è¯­è¨€åŒ…å®‰è£…å¤±è´¥ä¸é˜»æ–­æ„å»ºï¼ˆæ ¸å¿ƒæ˜¯ç¼–ç ï¼Œéå¿…é¡»ï¼‰

    - name: å®‰è£…ä¸­æ–‡å­—ä½“ï¼ˆæ›¿ä»£chocoï¼Œç”¨ç³»ç»Ÿè‡ªå¸¦/å¯é æºï¼‰
      run: |
        # æ–¹æ¡ˆ1ï¼šå¯ç”¨ç³»ç»Ÿè‡ªå¸¦ä¸­æ–‡å­—ä½“ï¼ˆWindows Serveré»˜è®¤å·²åŒ…å«ï¼Œä»…éœ€è§£é”ï¼‰
        reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Fonts" /v "Microsoft YaHei & Microsoft YaHei UI (TrueType)" /t REG_SZ /d msyh.ttc /f
        # æ–¹æ¡ˆ2ï¼šä»å¯é æºå®‰è£…å­—ä½“ï¼ˆå¤‡ç”¨ï¼‰
        Invoke-WebRequest -Uri "https://github.com/miclle/fonts/raw/master/msyh.ttc" -OutFile "C:\Windows\Fonts\msyh.ttc"
      shell: powershell
      continue-on-error: true  # å­—ä½“å®‰è£…å¤±è´¥ä¸é˜»æ–­æ„å»º

    - name: ç¼–è¯‘é¡¹ç›®ï¼ˆå¼ºåˆ¶UTF-8è§£ææºç +Unicodeå­—ç¬¦é›†ï¼‰
      run: |
        chcp 65001
        msbuild ./SocialNetwork.sln ^
          /p:Configuration=Release ^
          /p:Platform=x64 ^
          /p:OutDir=./bin/Release ^
          /p:PlatformToolset=v143 ^
          /p:CharacterSet=Unicode ^
          /p:ForceUTF8=true ^
          /utf-8 ^
          /p:AdditionalOptions="/utf-8 %(AdditionalOptions)"
      shell: cmd

    - name: ä¸Šä¼  EXE åˆ° Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-exe
        path: ./bin/Release/*.exe

    - name: åˆ›å»º GitHub Release å¹¶ä¸Šä¼  EXE
      uses: softprops/action-gh-release@v2
      with:
        files: ./bin/Release/*.exe
        name: Release ${{ github.ref_name }}
        body: è‡ªåŠ¨æ„å»ºçš„ç‰ˆæœ¬ ${{ github.ref_name }}