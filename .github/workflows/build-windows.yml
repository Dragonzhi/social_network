name: 构建 Windows 可执行文件

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: 拉取代码（含完整历史）
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: 配置 MSBuild（确保加载 VS2022 工具）
      uses: microsoft/setup-msbuild@v2
      with:
        vs-version: '2022'  # 明确指定使用 VS2022

    - name: 编译项目（Release + x64 + v143 工具集）
      run: |
        # 路径改为仓库根目录的 sln，参数明确指定工具集和输出目录
        msbuild "SocialNetwork.sln" `
          /t:Build `
          /p:Configuration=Release `
          /p:Platform=x64 `
          /p:PlatformToolset=v143 `
          /p:WindowsTargetPlatformVersion=10.0.22621.0 `
          /p:OutDir="./bin/Release/"

    - name: 生成更新日志
      id: generate_changelog
      run: |
        $lastTag = git describe --abbrev=0 --tags HEAD^ 2>$null
        if (-not $lastTag) {
          $changelog = git log --pretty=format:"- %s" HEAD
        } else {
          $changelog = git log "$lastTag..HEAD" --pretty=format:"- %s"
        }
        if (-not $changelog) { $changelog = "无显著更新" }
        echo "CHANGELOG=$changelog" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

    - name: 上传 EXE 到 Release
      uses: softprops/action-gh-release@v2
      with:
        files: ./bin/Release/*.exe
        name: Release ${{ github.ref_name }}
        body: |
          ## 更新日志
          ${{ env.CHANGELOG }}
          
          自动构建版本：${{ github.ref_name }}
